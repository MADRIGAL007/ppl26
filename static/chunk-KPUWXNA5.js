import{a as d}from"./chunk-KZPLNQ7B.js";import{T as r,a as o,b as c,p as h,t as l}from"./chunk-OJFOISDS.js";var m=class g{constructor(){this.auth=l(d);this.systemSettings=r({});this.userSettings=r({});this.isLoading=r(!1)}async fetchSettings(){if(!this.auth.isAuthenticated())return;this.isLoading.set(!0);let t=this.auth.currentUser()?.role;try{let s={Authorization:`Bearer ${this.auth.token()}`},i=await fetch("/api/admin/me",{headers:s});if(i.ok){let e=await i.json(),a=c(o({},e.settings),{enabledFlows:e.settings.enabledFlows,telegramBotToken:e.telegramConfig?.token,telegramChatId:e.telegramConfig?.chat});this.userSettings.set(a)}if(t==="hypervisor"){let e=await fetch("/api/settings",{headers:s});if(e.ok){let a=await e.json(),f=c(o({},a),{telegramBotToken:a.tgToken,telegramChatId:a.tgChat});this.systemSettings.set(f)}}}catch(n){console.error("[Settings] Fetch failed",n)}finally{this.isLoading.set(!1)}}async updateSystemSetting(t,n){if(this.auth.currentUser()?.role!=="hypervisor")return;let s=t==="telegramBotToken"?"tgToken":t==="telegramChatId"?"tgChat":t;await this.post("/api/settings",{key:s,value:String(n)}),this.fetchSettings()}async updateUserSetting(t,n){let s=this.userSettings(),i={};if(t.startsWith("telegram")){let e={token:s.telegramBotToken,chat:s.telegramChatId};t==="telegramBotToken"&&(e.token=n),t==="telegramChatId"&&(e.chat=n),i.telegramConfig=e}else{let e=o({},s);delete e.telegramBotToken,delete e.telegramChatId,e[t]=n,i.settings=e}await this.post("/api/admin/settings",i),this.fetchSettings()}async post(t,n){let s=this.auth.token();try{await fetch(t,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(n)})}catch(i){console.error("[Settings] Update failed",i)}}getEffective(t){return this.userSettings()[t]||this.systemSettings()[t]}static{this.\u0275fac=function(n){return new(n||g)}}static{this.\u0275prov=h({token:g,factory:g.\u0275fac,providedIn:"root"})}};export{m as a};
